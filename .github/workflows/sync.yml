name: Sync from GitLab

on:
  schedule:
    # 08:00 UTC
    - cron: '0 8 * * *'
    # 16:00 UTC
    - cron: '0 16 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.GITLAB_SSH_KEY }}

      - name: Add GitLab host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan code.ihep.ac.cn >> ~/.ssh/known_hosts

      - name: Configure git
        run: |
          git config --global user.name "heris-sync-bot"
          git config --global user.email "albert.cheung@cern.ch"

      - name: Mirror from GitLab to GitHub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. 用 SSH 从 GitLab clone mirror
          git clone --mirror "git@code.ihep.ac.cn:heris/bendis.git" repo.git

          cd repo.git

          # 2. 加 GitHub 作为 push 目标
          git remote add github "https://x-access-token:${GITHUB_TOKEN}@github.com/albertc9/Bendis.git"

          # 3. 把所有 refs（branches/tags）完整镜像到 GitHub
          git push --mirror github
