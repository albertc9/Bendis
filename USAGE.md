# Bendis Usage Guide

Complete guide for using Bendis in your Heris hardware project.

## Table of Contents

1. [Quick Start](#quick-start)
2. [Commands](#commands)
3. [Workflow Examples](#workflow-examples)
4. [File Structure](#file-structure)
5. [Best Practices](#best-practices)
6. [Troubleshooting](#troubleshooting)

## Quick Start

### First Time Setup

1. **Navigate to your project**:
   ```bash
   cd /path/to/your/hardware/project
   ```

2. **Initialize Bendis**:
   ```bash
   bendis init
   ```

   This creates:
   - `.bendis/` directory
   - `.bendis/Bender.yml` (blank)
   - `.bendis/.bender.yml` (blank)

3. **Edit your configuration**:
   ```bash
   vim .bendis/Bender.yml
   ```

   Example `Bender.yml`:
   ```yaml
   package:
     name: my_project

   dependencies:
     common_cells: { git: "https://github.com/pulp-platform/common_cells.git", version: 1.21.0 }
     axi: { git: "https://github.com/pulp-platform/axi.git", version: 0.39.0 }

   sources:
     - src/top.sv
     - src/module.sv
   ```

4. **Run update**:
   ```bash
   bendis update
   ```

   This will:
   - Generate `.bendis/Bender.lock`
   - Convert GitHub URLs to IHEP internal URLs
   - Create `Bender.yml` and `.bender.yml` in project root
   - Generate final `Bender.lock` with internal URLs
   - Download all dependencies to `.bender/`

## Commands

### `bendis init`

Initialize a new Bendis project.

```bash
bendis init
```

**What it does**:
- Creates `.bendis/` directory
- Creates blank `.bendis/Bender.yml`
- Creates blank `.bendis/.bender.yml`

**Safety checks**:
- Refuses if `.bendis/Bender.yml` or `.bendis/.bender.yml` already exist with content

### `bendis update`

Update dependencies with URL conversion.

```bash
bendis update
```

**5-Step Process**:

1. **Step 1**: Run `bender -d ./.bendis update`
   - Generates `.bendis/Bender.lock`
   - Creates `.bendis/.bender/` (temporary)

2. **Step 2**: Convert URLs and generate files
   - Reads `.bendis/Bender.yml`, `.bendis/.bender.yml`, `.bendis/Bender.lock`
   - Converts GitHub URLs → IHEP internal URLs
   - Copies `Bender.yml` to root
   - Generates new `.bender.yml` in root with converted URLs

3. **Step 3**: Run `bender update` in root
   - Uses new `Bender.yml` and `.bender.yml`
   - Generates `Bender.lock` in root
   - Downloads dependencies to `.bender/`

4. **Step 4**: Cleanup
   - Removes `.bendis/.bender/` (temporary files)

5. **Step 5**: Verification
   - Checks all required files exist

### `bendis <other commands>`

Pass through to Bender.

```bash
bendis packages
bendis script vsim
bendis checkout
bendis path common_cells
```

All commands except `init` and `update` are passed directly to Bender.

### `bendis --version` / `bendis -v`

Show version information.

```bash
bendis --version
```

### `bendis --help` / `bendis -h`

Show help message.

```bash
bendis --help
```

## Workflow Examples

### Example 1: New Project

```bash
# Create project directory
mkdir my_chip && cd my_chip

# Initialize Bendis
bendis init

# Create your Bender.yml
cat > .bendis/Bender.yml << 'EOF'
package:
  name: my_chip

dependencies:
  common_cells: { git: "https://github.com/pulp-platform/common_cells.git", version: 1.21.0 }
  axi: { git: "https://github.com/pulp-platform/axi.git", version: 0.39.0 }

sources:
  - rtl/top.sv
EOF

# Update dependencies
bendis update

# Generate simulation script
bendis script vsim > compile.tcl
```

### Example 2: Adding New Dependency

```bash
# Edit Bender.yml to add new dependency
vim .bendis/Bender.yml

# Add to dependencies section:
#   register_interface: { git: "https://github.com/pulp-platform/register_interface.git", version: 0.4.0 }

# Update
bendis update
```

### Example 3: Updating Dependency Version

```bash
# Edit Bender.yml to change version
vim .bendis/Bender.yml

# Change version: 1.21.0 → 1.22.0

# Update
bendis update
```

### Example 4: Using Local Override

```bash
# Edit .bendis/.bender.yml
cat > .bendis/.bender.yml << 'EOF'
overrides:
  common_cells: { path: "../my_custom_common_cells" }
EOF

# Update
bendis update
```

## File Structure

### Before `bendis init`

```
my_project/
└── rtl/
    └── top.sv
```

### After `bendis init`

```
my_project/
├── .bendis/
│   ├── Bender.yml       (blank - you edit this)
│   └── .bender.yml      (blank - optional overrides)
└── rtl/
    └── top.sv
```

### After `bendis update`

```
my_project/
├── .bendis/
│   ├── Bender.yml       (your original config)
│   ├── .bender.yml      (your overrides)
│   └── Bender.lock      (generated by bender)
├── .bender/             (dependencies downloaded here)
│   ├── common_cells/
│   └── axi/
├── Bender.yml           (copied from .bendis/)
├── .bender.yml          (generated with IHEP URLs)
├── Bender.lock          (final lock file)
└── rtl/
    └── top.sv
```

## Best Practices

### 1. Version Control

Add to `.gitignore`:

```gitignore
.bender/
.bendis/.bender/
Bender.lock
```

Commit to git:

```gitignore
.bendis/Bender.yml
.bendis/.bender.yml
.bendis/Bender.lock
Bender.yml
.bender.yml
```

### 2. Dependency Management

- **Always edit `.bendis/Bender.yml`**, not root `Bender.yml`
- Root `Bender.yml` is auto-generated (will be overwritten)
- Use specific versions for reproducible builds
- Use `.bendis/.bender.yml` for local overrides only

### 3. Team Collaboration

- Share `.bendis/Bender.yml` and `.bendis/Bender.lock` in git
- Team members just need to run `bendis update`
- Everyone gets the same dependency versions

### 4. CI/CD Integration

```bash
#!/bin/bash
# ci-build.sh

# Install Bendis (one time)
# make install

# Update dependencies
bendis update

# Run tests
bendis script vsim > compile.tcl
vsim -c -do compile.tcl -do "run -all; quit"
```

## Troubleshooting

### Error: "bendis: command not found"

**Solution**: Add Bendis to PATH via `settings.sh`:

```bash
echo 'source /path/to/bendis/settings.sh' >> ~/.bashrc
source ~/.bashrc
```

### Error: "bender: command not found"

**Solution**: Install Bender:

```bash
curl --proto '=https' --tlsv1.2 https://pulp-platform.github.io/bender/init -sSf | sh
```

### Error: ".bendis directory not found"

**Solution**: Run `bendis init` first.

### Error: "Initialization failed! .bendis/Bender.yml already exists with content"

**Solution**: Either:
- Backup existing file: `mv .bendis/Bender.yml .bendis/Bender.yml.backup`
- Or delete it: `rm .bendis/Bender.yml`
- Then run `bendis init` again

### Bender update fails in step 1

**Check**:
1. Is `.bendis/Bender.yml` valid YAML?
2. Do dependencies exist and are accessible?
3. Is network connection working?

**Debug**:
```bash
cd .bendis
bender update  # Run bender directly to see errors
```

### URL conversion not working

**Check**: Are URLs in the format `github.com/pulp-platform/*`?

Only URLs matching this pattern are converted. Other URLs pass through unchanged.

### Dependencies not downloading

**Check**:
1. Network access to `code.ihep.ac.cn`
2. SSH keys configured for git access
3. Permissions on the repositories

### Performance is slow

**Solution**: Bendis in Rust should be fast. If slow:
1. Check network speed
2. Use release build: `cargo build --release`
3. Large number of dependencies is expected to take time

## Advanced Usage

### Custom URL Conversion

To modify URL conversion logic, edit `bendis/src/converter/format.rs`:

```rust
fn convert_url(git_url: &str) -> String {
    // Add your custom conversion logic here
    if git_url.contains("github.com/pulp-platform") {
        // ...
    }
    git_url.to_string()
}
```

### Integration with Makefiles

```makefile
.PHONY: deps update clean

deps:
	bendis update

simulate: deps
	bendis script vsim > sim/compile.tcl
	cd sim && vsim -c -do compile.tcl

clean:
	rm -rf .bender/
```

## Getting Help

- Run `bendis --help` for command overview
- See [README.md](README.md) for project information
- See [BUILD.md](BUILD.md) for build instructions
- Check [bender documentation](https://github.com/pulp-platform/bender) for Bender details

## Summary

Bendis simplifies dependency management in Heris hardware projects by:
- Automating URL conversion (GitHub → IHEP internal)
- Managing dependency versions intelligently
- Providing a seamless wrapper around Bender
- Ensuring reproducible builds across the team

**Typical workflow**:
1. Edit `.bendis/Bender.yml`
2. Run `bendis update`
3. Use `bendis <command>` for all Bender operations
